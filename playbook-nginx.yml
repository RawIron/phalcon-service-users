---

- hosts: default
  remote_user: root
  become: yes
  become_method: sudo

  vars:
    nginx_remove_default_vhost: true
    nginx_vhosts:
      - listen: "80"
        server_name: "_"
        root: "/code"
        index: "index.php index.html index.htm"
        extra_parameters: |
          location / {
            try_files $uri $uri/ /index.php?_url=$uri&$args;
          }

          location ~ \.php$ {
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 172.17.0.3:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO       $fastcgi_path_info;
            fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
            include fastcgi_params;
          }

          location ~ /\.ht {
              deny all;
          }

  roles:
    - { role: geerlingguy.nginx, tags: ['nginx'] }

